USE CDP

--DROP TABLE Audit

-- 建立稽核紀錄表 (Audit)
CREATE TABLE Audit (
    Id BIGINT IDENTITY PRIMARY KEY,     -- 主鍵，自動遞增
    UserId NVARCHAR(50) NOT NULL,       -- 使用者ID
    FrontUrl NVARCHAR(4000) NULL,       -- 前端完整 URL，供稽核使用
    FrontActionId NVARCHAR(50) NULL,    -- 同批次操作識別碼
    FrontActionName NVARCHAR(100) NULL, -- 前端按鈕，供稽核使用
    BackActionName NVARCHAR(200),       -- Controller/Service 動作
    HttpMethod NVARCHAR(10),            -- HTTP 方法 (GET/POST/PUT/DELETE)
    HttpStatusCode NVARCHAR(10),        -- HTTP 回應
    RequestPath NVARCHAR(1000),         -- API 請求路徑
    Parameters NVARCHAR(4000),          -- JSON 格式的傳入參數
    ResponseBody NVARCHAR(4000),        -- JSON 格式的傳出
    IpAddress NVARCHAR(100),            -- 呼叫來源 IP
    CreateAt DATETIME NOT NULL          -- 建立時間
        DEFAULT (GETDATE())             -- 預設當下伺服器時間
);
GO

-- === Extended Properties 註解 ===
EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'稽核紀錄表，紀錄 API 使用者操作行為', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'主鍵，自動遞增', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'Id';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'使用者ID（來源於 JWT 或登入帳號）', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'UserId';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'前端完整 URL，供稽核使用', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'FrontUrl';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'同批次操作識別碼', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'FrontActionId';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'前端按鈕，供稽核使用', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'FrontActionName';
  
EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'動作名稱，例如 Controller/Service 方法名稱', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'BackActionName';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'HTTP 方法 (GET/POST/PUT/DELETE)', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'HttpMethod';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'HTTP 回應', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'HttpStatusCode';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'API 請求路徑，例如 /api/orders/123', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'RequestPath';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'JSON 格式的傳入參數（支援物件、欄位查詢）', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'Parameters';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'JSON 格式的傳出', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'ResponseBody';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'呼叫來源 IP 位址', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'IpAddress';

EXEC sp_addextendedproperty 
    @name = N'MS_Description', 
    @value = N'建立時間（預設為伺服器當下時間）', 
    @level0type = N'SCHEMA', @level0name = 'dbo',
    @level1type = N'TABLE',  @level1name = 'Audit',
    @level2type = N'COLUMN', @level2name = 'CreateAt';
GO
